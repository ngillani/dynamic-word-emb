import torch, re
from torchtext.vocab import Vocab
from torchtext.data import Field, TabularDataset

from utils import DATA_DIR, read_dict
from os.path import join

def _tokenize_str(str_):
    # keep only alphanumeric and punctations
    str_ = re.sub(r'[^A-Za-z0-9(),.!?\'`]', ' ', str_)
    # remove multiple whitespace characters
    str_ = re.sub(r'\s{2,}', ' ', str_)
    # punctations to tokens
    str_ = re.sub(r'\(', ' ( ', str_)
    str_ = re.sub(r'\)', ' ) ', str_)
    str_ = re.sub(r',', ' , ', str_)
    str_ = re.sub(r'\.', ' . ', str_)
    str_ = re.sub(r'!', ' ! ', str_)
    str_ = re.sub(r'\?', ' ? ', str_)
    # split contractions into multiple tokens
    str_ = re.sub(r'\'s', ' \'s', str_)
    str_ = re.sub(r'\'ve', ' \'ve', str_)
    str_ = re.sub(r'n\'t', ' n\'t', str_)
    str_ = re.sub(r'\'re', ' \'re', str_)
    str_ = re.sub(r'\'d', ' \'d', str_)
    str_ = re.sub(r'\'ll', ' \'ll', str_)
    # lower case
    return str_.strip().lower().split()


file_path = join(DATA_DIR, 'sample.csv')
id_field = Field(sequential=False, use_vocab=False, dtype=torch.int)
text_field = Field(pad_token=None, tokenize=_tokenize_str)

dataset = TabularDataset(
	path=file_path,
	format='csv',
	fields=[('id', id_field), ('text', text_field)],
	skip_header=True)

text_field.build_vocab(dataset)
curr_vocab = dataset.fields['text'].vocab
print curr_vocab.itos
print curr_vocab.stoi['the']


# Radio
# curr = {'migrants': Counter({u'16': 46, u'19': 39, u'10': 36, u'11': 34, u'14': 34, u'4': 32, u'18': 32, u'15': 30, u'31': 29, u'12': 25, u'13': 24, u'8': 22, u'30': 21, u'25': 18, u'22': 18, u'28': 18, u'20': 16, u'6': 16, u'24': 14, u'9': 14, u'3': 13, u'7': 13, u'26': 12, u'21': 12, u'23': 11, u'27': 10, u'0': 10, u'5': 10, u'17': 8, u'29': 7, u'2': 6, u'1': 4}), 'refugee': Counter({u'1': 63, u'0': 51, u'19': 43, u'6': 37, u'23': 35, u'2': 35, u'22': 34, u'13': 33, u'31': 33, u'8': 26, u'27': 24, u'3': 24, u'26': 23, u'4': 23, u'14': 22, u'5': 21, u'17': 21, u'10': 19, u'18': 19, u'30': 19, u'21': 17, u'29': 17, u'11': 17, u'12': 14, u'25': 12, u'7': 12, u'9': 11, u'15': 11, u'20': 10, u'16': 10, u'28': 9, u'24': 8}), 'immigrants': Counter({u'7': 382, u'8': 256, u'9': 160, u'22': 145, u'1': 138, u'6': 137, u'21': 131, u'12': 117, u'15': 114, u'23': 111, u'30': 111, u'2': 106, u'14': 101, u'0': 98, u'11': 91, u'16': 91, u'20': 87, u'5': 85, u'17': 82, u'10': 78, u'13': 75, u'3': 72, u'29': 68, u'31': 68, u'19': 62, u'4': 59, u'18': 40, u'28': 38, u'25': 37, u'26': 36, u'24': 32, u'27': 32}), 'immigrant': Counter({u'7': 375, u'8': 243, u'6': 116, u'9': 95, u'22': 93, u'21': 78, u'23': 76, u'10': 72, u'16': 65, u'12': 64, u'15': 62, u'17': 61, u'5': 59, u'1': 52, u'30': 51, u'19': 50, u'11': 46, u'13': 45, u'20': 38, u'3': 37, u'0': 36, u'18': 36, u'4': 34, u'31': 33, u'26': 31, u'2': 30, u'25': 28, u'29': 27, u'14': 26, u'24': 25, u'28': 23, u'27': 21}), 'migrant': Counter({u'2': 30, u'18': 28, u'19': 22, u'22': 20, u'23': 20, u'16': 20, u'4': 18, u'1': 17, u'6': 14, u'14': 14, u'30': 14, u'3': 12, u'5': 12, u'8': 12, u'31': 12, u'28': 11, u'0': 11, u'11': 10, u'10': 10, u'26': 8, u'29': 8, u'7': 8, u'13': 8, u'15': 8, u'25': 7, u'27': 6, u'17': 6, u'21': 5, u'9': 5, u'12': 4, u'20': 3, u'24': 1}), 'asylum': Counter({u'31': 73, u'6': 56, u'23': 45, u'21': 43, u'3': 43, u'22': 39, u'29': 31, u'20': 30, u'27': 28, u'30': 23, u'10': 21, u'2': 19, u'18': 18, u'0': 16, u'9': 16, u'24': 15, u'25': 15, u'13': 14, u'4': 13, u'14': 13, u'19': 13, u'26': 11, u'16': 11, u'5': 10, u'11': 10, u'1': 8, u'7': 8, u'8': 8, u'12': 7, u'17': 7, u'28': 4, u'15': 1}), 'refugees': Counter({u'17': 78, u'13': 70, u'6': 56, u'22': 44, u'23': 43, u'8': 41, u'31': 41, u'1': 40, u'16': 40, u'10': 38, u'2': 37, u'26': 33, u'4': 32, u'0': 30, u'14': 29, u'29': 26, u'11': 26, u'19': 26, u'18': 26, u'3': 22, u'7': 22, u'12': 20, u'27': 19, u'5': 19, u'28': 18, u'9': 18, u'25': 16, u'20': 16, u'24': 14, u'30': 12, u'21': 10, u'15': 10})}

# COHA
# curr = {'judge': Counter({u'2': 3643, u'1': 3594, u'5': 3383, u'3': 3104, u'4': 3053, u'0': 2903, u'6': 2802, u'7': 2774, u'8': 2023}), 'supervisor': Counter({u'7': 264, u'2': 237, u'8': 224, u'3': 193, u'5': 175, u'6': 164, u'4': 113, u'1': 58, u'0': 23}), 'lawyer': Counter({u'7': 1728, u'6': 1546, u'4': 1465, u'5': 1344, u'8': 1308, u'2': 1251, u'0': 1223, u'1': 1108, u'3': 1049}), 'sales': Counter({u'7': 2576, u'8': 2171, u'2': 1897, u'5': 1858, u'4': 1736, u'6': 1471, u'3': 1233, u'1': 970, u'0': 198}), 'carpenter': Counter({u'2': 471, u'1': 273, u'3': 271, u'0': 213, u'7': 213, u'8': 209, u'5': 205, u'4': 200, u'6': 144}), 'administrator': Counter({u'3': 522, u'2': 458, u'5': 340, u'4': 324, u'6': 311, u'7': 294, u'8': 237, u'1': 117, u'0': 111}), 'surveyor': Counter({u'5': 73, u'0': 57, u'1': 45, u'2': 37, u'6': 29, u'4': 24, u'8': 22, u'3': 19, u'7': 15}), 'sailor': Counter({u'1': 476, u'0': 476, u'3': 389, u'4': 376, u'2': 337, u'6': 285, u'5': 278, u'7': 210, u'8': 205}), 'dancer': Counter({u'8': 344, u'4': 299, u'7': 290, u'6': 270, u'5': 224, u'2': 220, u'3': 189, u'1': 145, u'0': 137}), 'midwife': Counter({u'7': 86, u'8': 68, u'3': 52, u'4': 40, u'6': 37, u'2': 35, u'5': 24, u'1': 11, u'0': 7}), 'operator': Counter({u'5': 671, u'3': 610, u'4': 488, u'6': 434, u'2': 430, u'7': 382, u'1': 372, u'8': 369, u'0': 324}), 'retired': Counter({u'8': 946, u'7': 731, u'6': 719, u'1': 662, u'5': 659, u'2': 617, u'4': 614, u'3': 537, u'0': 422}), 'inspector': Counter({u'2': 679, u'0': 454, u'3': 380, u'5': 380, u'6': 366, u'1': 350, u'7': 333, u'4': 232, u'8': 145}), 'mason': Counter({u'3': 944, u'2': 663, u'5': 509, u'8': 353, u'0': 297, u'4': 262, u'1': 260, u'7': 254, u'6': 213}), 'economist': Counter({u'7': 621, u'8': 338, u'6': 269, u'5': 190, u'4': 188, u'3': 151, u'2': 135, u'1': 99, u'0': 65}), 'surgeon': Counter({u'4': 496, u'1': 341, u'0': 334, u'2': 333, u'5': 322, u'3': 301, u'8': 301, u'7': 291, u'6': 283}), 'engineer': Counter({u'7': 1090, u'3': 1048, u'4': 731, u'5': 680, u'1': 659, u'2': 645, u'0': 632, u'8': 567, u'6': 495}), 'clerical': Counter({u'3': 136, u'5': 133, u'4': 122, u'2': 121, u'7': 108, u'1': 99, u'6': 82, u'0': 76, u'8': 71}), 'police': Counter({u'6': 6261, u'5': 5650, u'4': 4713, u'2': 4479, u'7': 4210, u'8': 4180, u'3': 3833, u'1': 3650, u'0': 1864}), 'sheriff': Counter({u'1': 1407, u'3': 894, u'2': 845, u'6': 736, u'4': 691, u'5': 626, u'0': 514, u'7': 476, u'8': 447}), 'doctor': Counter({u'1': 5148, u'4': 4367, u'2': 4125, u'0': 3743, u'5': 3720, u'3': 3593, u'8': 3136, u'6': 3055, u'7': 3007}), 'photographer': Counter({u'8': 414, u'6': 341, u'5': 305, u'3': 258, u'7': 253, u'4': 232, u'2': 225, u'0': 82, u'1': 74}), 'smith': Counter({u'1': 3296, u'2': 2774, u'8': 2752, u'0': 2405, u'7': 2271, u'3': 1990, u'4': 1720, u'5': 1515, u'6': 1477}), 'auctioneer': Counter({u'4': 108, u'3': 87, u'2': 68, u'8': 59, u'1': 44, u'7': 43, u'6': 17, u'0': 14, u'5': 14}), 'accountant': Counter({u'8': 143, u'2': 108, u'7': 103, u'5': 98, u'6': 96, u'4': 93, u'1': 37, u'3': 36, u'0': 19}), 'geologist': Counter({u'8': 70, u'1': 63, u'4': 35, u'3': 31, u'0': 30, u'7': 30, u'5': 28, u'6': 27, u'2': 24}), 'author': Counter({u'8': 2033, u'0': 1641, u'1': 1508, u'2': 1294, u'7': 1269, u'4': 1257, u'3': 1166, u'5': 1074, u'6': 1005}), 'farmer': Counter({u'1': 1658, u'2': 1476, u'0': 1318, u'3': 1035, u'4': 808, u'5': 737, u'7': 721, u'6': 686, u'8': 601}), 'shoemaker': Counter({u'5': 77, u'2': 71, u'4': 71, u'8': 70, u'1': 57, u'7': 38, u'0': 35, u'6': 34, u'3': 20}), 'professor': Counter({u'0': 2390, u'8': 2058, u'5': 1967, u'6': 1847, u'4': 1846, u'1': 1817, u'2': 1799, u'3': 1584, u'7': 1556}), 'clerk': Counter({u'2': 1108, u'4': 882, u'3': 828, u'1': 760, u'5': 758, u'0': 728, u'7': 676, u'6': 654, u'8': 549}), 'gardener': Counter({u'4': 211, u'0': 174, u'7': 168, u'1': 147, u'8': 145, u'2': 119, u'3': 106, u'6': 102, u'5': 93}), 'porter': Counter({u'0': 654, u'3': 468, u'5': 440, u'2': 414, u'4': 386, u'1': 378, u'8': 301, u'7': 296, u'6': 237}), 'postmaster': Counter({u'2': 258, u'1': 187, u'6': 182, u'0': 168, u'3': 106, u'4': 88, u'5': 73, u'8': 44, u'7': 31}), 'designer': Counter({u'8': 517, u'7': 399, u'6': 236, u'3': 212, u'5': 192, u'4': 170, u'1': 117, u'2': 104, u'0': 72}), 'clergy': Counter({u'5': 237, u'3': 172, u'7': 169, u'2': 155, u'1': 153, u'4': 147, u'6': 143, u'0': 133, u'8': 133}), 'guard': Counter({u'7': 2047, u'4': 2022, u'5': 1965, u'1': 1880, u'8': 1856, u'3': 1855, u'2': 1854, u'6': 1690, u'0': 1650}), 'manager': Counter({u'8': 1853, u'7': 1655, u'4': 1414, u'6': 1327, u'5': 1278, u'2': 1277, u'1': 1186, u'3': 1161, u'0': 697}), 'driver': Counter({u'6': 1677, u'8': 1545, u'4': 1305, u'5': 1275, u'7': 1264, u'3': 1125, u'2': 988, u'1': 784, u'0': 599}), 'statistician': Counter({u'1': 36, u'2': 33, u'3': 24, u'8': 24, u'7': 23, u'0': 21, u'6': 18, u'5': 17, u'4': 16}), 'musician': Counter({u'8': 231, u'1': 208, u'7': 174, u'2': 161, u'4': 148, u'6': 146, u'3': 139, u'5': 121, u'0': 118}), 'cashier': Counter({u'1': 248, u'2': 172, u'0': 106, u'3': 102, u'5': 99, u'8': 97, u'4': 85, u'6': 66, u'7': 55}), 'physicist': Counter({u'7': 322, u'4': 166, u'8': 144, u'5': 142, u'2': 132, u'3': 119, u'6': 106, u'1': 73, u'0': 44}), 'broker': Counter({u'2': 308, u'7': 307, u'8': 259, u'1': 215, u'4': 179, u'0': 166, u'5': 136, u'6': 128, u'3': 121}), 'dentist': Counter({u'1': 253, u'4': 211, u'8': 188, u'5': 167, u'6': 165, u'7': 143, u'3': 142, u'2': 131, u'0': 82}), 'tailor': Counter({u'0': 226, u'1': 172, u'7': 153, u'2': 152, u'4': 148, u'8': 142, u'3': 141, u'6': 122, u'5': 121}), 'student': Counter({u'5': 2541, u'8': 2393, u'6': 1896, u'7': 1683, u'4': 1527, u'2': 1034, u'1': 980, u'3': 959, u'0': 950}), 'cook': Counter({u'8': 1699, u'1': 1263, u'6': 1208, u'4': 1170, u'0': 1095, u'7': 1069, u'2': 954, u'3': 882, u'5': 775}), 'librarian': Counter({u'0': 221, u'8': 190, u'4': 85, u'2': 76, u'3': 74, u'5': 74, u'7': 73, u'1': 65, u'6': 49}), 'attendant': Counter({u'8': 347, u'5': 320, u'7': 278, u'6': 261, u'0': 259, u'2': 249, u'4': 238, u'1': 204, u'3': 182}), 'instructor': Counter({u'8': 288, u'4': 255, u'5': 241, u'6': 189, u'1': 157, u'3': 152, u'2': 141, u'7': 139, u'0': 106}), 'teacher': Counter({u'8': 2261, u'5': 1723, u'0': 1611, u'4': 1447, u'6': 1311, u'7': 1253, u'1': 1223, u'2': 1178, u'3': 768}), 'nurse': Counter({u'8': 1329, u'6': 1157, u'3': 1056, u'0': 983, u'4': 950, u'7': 889, u'2': 860, u'5': 711, u'1': 689}), 'painter': Counter({u'8': 461, u'7': 420, u'5': 392, u'1': 380, u'3': 379, u'4': 367, u'6': 353, u'0': 327, u'2': 313}), 'pilot': Counter({u'4': 1047, u'7': 1040, u'5': 976, u'3': 827, u'8': 796, u'6': 749, u'2': 671, u'1': 587, u'0': 248}), 'physician': Counter({u'0': 691, u'8': 578, u'1': 553, u'7': 540, u'5': 536, u'4': 531, u'3': 502, u'2': 489, u'6': 419}), 'collector': Counter({u'4': 245, u'1': 233, u'8': 226, u'7': 221, u'2': 204, u'6': 192, u'0': 181, u'5': 172, u'3': 135}), 'laborer': Counter({u'1': 157, u'0': 156, u'2': 133, u'3': 78, u'4': 72, u'5': 64, u'6': 59, u'7': 56, u'8': 48}), 'artist': Counter({u'8': 1891, u'6': 1213, u'1': 1160, u'7': 1073, u'0': 1041, u'2': 928, u'3': 786, u'4': 785, u'5': 759}), 'mathematician': Counter({u'7': 65, u'8': 65, u'4': 63, u'2': 54, u'3': 51, u'5': 51, u'6': 45, u'1': 39, u'0': 27}), 'housekeeper': Counter({u'0': 251, u'1': 209, u'3': 148, u'2': 137, u'4': 120, u'6': 120, u'7': 113, u'8': 111, u'5': 86}), 'athlete': Counter({u'8': 267, u'7': 209, u'4': 147, u'6': 142, u'5': 138, u'1': 93, u'3': 88, u'2': 78, u'0': 56}), 'official': Counter({u'7': 2973, u'5': 2726, u'6': 2698, u'4': 2561, u'3': 2489, u'2': 2415, u'1': 2166, u'8': 1605, u'0': 1530}), 'psychologist': Counter({u'8': 384, u'7': 222, u'4': 218, u'5': 183, u'6': 129, u'1': 127, u'2': 116, u'0': 94, u'3': 88}), 'bailiff': Counter({u'4': 81, u'3': 75, u'5': 39, u'2': 33, u'7': 28, u'1': 27, u'6': 20, u'8': 20, u'0': 9}), 'soldier': Counter({u'3': 1820, u'0': 1383, u'4': 1303, u'1': 1156, u'2': 1014, u'5': 924, u'6': 902, u'7': 881, u'8': 809}), 'scientist': Counter({u'5': 518, u'8': 508, u'7': 488, u'4': 440, u'6': 419, u'2': 370, u'3': 293, u'1': 285, u'0': 169}), 'architect': Counter({u'8': 500, u'7': 325, u'5': 304, u'4': 284, u'1': 283, u'6': 252, u'3': 248, u'2': 217, u'0': 166}), 'chemist': Counter({u'1': 232, u'7': 195, u'0': 141, u'4': 141, u'3': 140, u'2': 127, u'5': 84, u'8': 77, u'6': 70}), 'mechanic': Counter({u'1': 187, u'8': 173, u'6': 170, u'2': 164, u'5': 152, u'3': 151, u'4': 146, u'7': 115, u'0': 69}), 'blacksmith': Counter({u'1': 142, u'0': 133, u'2': 131, u'3': 101, u'5': 74, u'4': 66, u'8': 65, u'6': 62, u'7': 50}), 'weaver': Counter({u'0': 208, u'7': 154, u'8': 139, u'4': 134, u'3': 91, u'5': 74, u'1': 68, u'2': 67, u'6': 58}), 'janitor': Counter({u'2': 132, u'1': 107, u'8': 92, u'3': 87, u'0': 80, u'4': 76, u'6': 73, u'7': 60, u'5': 58}), 'baker': Counter({u'7': 890, u'5': 889, u'8': 751, u'1': 621, u'0': 387, u'6': 386, u'2': 365, u'4': 296, u'3': 250}), 'secretary': Counter({u'4': 4735, u'1': 4440, u'3': 4205, u'5': 4095, u'2': 4028, u'6': 3809, u'7': 2879, u'0': 2074, u'8': 1595})}

# Counting word occurrences per doc
from scipy.stats import pearsonr
bias = [5.643071823371144e-06, -1.0479933877425944e-05, 1.6264965473384432e-05, 3.482771413224929e-06, -2.6416840900041845e-07, 1.7892589418668425e-05, 3.5031668323129826e-05, 9.17906187603579e-06, 0.0001981798546256374]
total_counts = [0 for i in range(0, len(bias))]
for w in curr:
    a = [0 for i in range(0, len(bias))]
    for ind in curr[w]:
        a[int(ind)] = curr[w][ind]
        total_counts[int(ind)] += curr[w][ind]
    print (w, pearsonr(a,bias), np.sum(a))    

print ('all', pearsonr(total_counts, bias))

